AWSTemplateFormatVersion: '2010-09-09'
Description: 'My Things Management - CF Custom Resource Helper Utils Lambda - Version %%VERSION%%'
Parameters:
    sourceBucket:
        Type: String
        Description: S3 Bucket for Lambda code.
    sourceKeyPrefix:
        Type: String
        Description: S3 Bucket Key prefix for Lambda code.
    destBucketArn:
        Type: String
        Description: ARN of the My Things Management Website Bucket.
    dataBucketArn:
        Type: String
        Description: ARN of the My Things Management Data Bucket.
    settingsTable:
        Type: String
        Description: DynamoDB Table for storing the application settings
    devicesTable:
        Type: String
        Description: DynamoDB Table for storing the devices
    deviceBlueprintsTable:
        Type: String
        Description: DynamoDB Table for storing the device blueprints
    deviceTypesTable:
        Type: String
        Description: DynamoDB Table for storing the device types
    solutionsTable:
        Type: String
        Description: DynamoDB Table for storing the solutions
    solutionBlueprintsTable:
        Type: String
        Description: DynamoDB Table for storing the solution blueprints

Resources:
    customResourceUtilsHelperRole:
        Type: 'AWS::IAM::Role'
        Properties:
            AssumeRolePolicyDocument:
                Version: '2012-10-17'
                Statement:
                    - Effect: 'Allow'
                      Principal:
                          Service:
                              - 'lambda.amazonaws.com'
                      Action:
                          - 'sts:AssumeRole'
            Path: '/'

    customResourceUtilsHelperPolicy:
        Type: 'AWS::IAM::ManagedPolicy'
        Properties:
            Description: 'My Things Management policy for the utils microservice Lambda function.'
            Roles:
                - !Ref 'customResourceUtilsHelperRole'
            PolicyDocument:
                Version: '2012-10-17'
                Statement:
                    -
                        Effect: 'Allow'
                        Action:
                            - 'logs:CreateLogGroup'
                            - 'logs:CreateLogStream'
                            - 'logs:PutLogEvents'
                        Resource: !Join ['', ['arn:aws:logs:', !Ref 'AWS::Region', ':', !Ref 'AWS::AccountId', ':log-group:/aws/lambda/', !Ref customResourceUtilsHelper, ':*']]
                    -
                        Effect: 'Allow'
                        Action:
                            - 's3:GetObject'
                            - 's3:ListObjectsV2'
                        Resource:
                            - 'arn:aws:s3:::*'
                    -
                        Effect: 'Allow'
                        Action:
                            - 's3:PutObject'
                        Resource:
                            - !Join ['/', [!Ref destBucketArn, '*']]
                            - !Join ['/', [!Ref dataBucketArn, '*']]
                    -
                        Effect: 'Allow'
                        Action:
                            - 'dynamodb:BatchGetItem'
                            - 'dynamodb:BatchWriteItem'
                            - 'dynamodb:DeleteItem'
                            - 'dynamodb:GetItem'
                            - 'dynamodb:PutItem'
                            - 'dynamodb:Query'
                            - 'dynamodb:Scan'
                            - 'dynamodb:UpdateItem'
                        Resource:
                            - !Join ['', ['arn:aws:dynamodb:', !Ref 'AWS::Region', ':', !Ref 'AWS::AccountId', ':table/', !Ref settingsTable]]
                            - !Join ['', ['arn:aws:dynamodb:', !Ref 'AWS::Region', ':', !Ref 'AWS::AccountId', ':table/', !Ref devicesTable]]
                            - !Join ['', ['arn:aws:dynamodb:', !Ref 'AWS::Region', ':', !Ref 'AWS::AccountId', ':table/', !Ref deviceBlueprintsTable]]
                            - !Join ['', ['arn:aws:dynamodb:', !Ref 'AWS::Region', ':', !Ref 'AWS::AccountId', ':table/', !Ref deviceTypesTable]]
                            - !Join ['', ['arn:aws:dynamodb:', !Ref 'AWS::Region', ':', !Ref 'AWS::AccountId', ':table/', !Ref solutionsTable]]
                            - !Join ['', ['arn:aws:dynamodb:', !Ref 'AWS::Region', ':', !Ref 'AWS::AccountId', ':table/', !Ref solutionBlueprintsTable]]

    customResourceUtilsHelper:
        Type: 'AWS::Lambda::Function'
        Properties:
            FunctionName: 'mythings-mgmt-custom-resource-helper-utils'
            Description: 'My Things Management Custom resource helper for deploying the app'
            Code:
                S3Bucket: !Ref sourceBucket
                S3Key: !Join ['/', [!Ref sourceKeyPrefix, 'mythings-mgmt-custom-resource-helper-utils.zip']]
            Handler: index.handler
            Runtime: nodejs8.10
            Role: !GetAtt customResourceUtilsHelperRole.Arn
            Timeout: 300
            MemorySize: 256
            Environment:
                Variables:
                    TABLE_DEVICES: !Ref devicesTable
                    TABLE_DEVICE_BLUEPRINTS: !Ref deviceBlueprintsTable
                    TABLE_DEVICE_TYPES: !Ref deviceTypesTable
                    TABLE_SOLUTIONS: !Ref solutionsTable
                    TABLE_SOLUTION_BLUEPRINTS: !Ref solutionBlueprintsTable
                    TABLE_SETTINGS: !Ref settingsTable
                    LOGGING_LEVEL: 2

Outputs:
    customResourceUtilsHelperArn:
        Description: 'Custom Resource Utils Helper ARN'
        Value: !GetAtt customResourceUtilsHelper.Arn
