# Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0

AWSTemplateFormatVersion: '2010-09-09'
Description: 'sputnik - CF Custom Resource Helper S3 Lambda - Version %%VERSION%%'
Parameters:
    sourceBucket:
        Type: String
        Description: S3 Bucket for Lambda code.
    lambdaSourceKeyPrefix:
        Type: String
        Description: S3 Bucket Key prefix for Lambda code.
    destBucketArn:
        Type: String
        Description: ARN of the sputnik Website Bucket.
    dataBucketArn:
        Type: String
        Description: ARN of the sputnik Data Bucket.
Resources:
    customResourceS3HelperRole:
        Type: 'AWS::IAM::Role'
        Properties:
            AssumeRolePolicyDocument:
                Version: '2012-10-17'
                Statement:
                    - Effect: 'Allow'
                      Principal:
                          Service:
                              - 'lambda.amazonaws.com'
                      Action:
                          - 'sts:AssumeRole'
            Path: '/'
            Policies:
                - PolicyName: 'customResourceS3HelperPolicy'
                  PolicyDocument:
                      Version: '2012-10-17'
                      Statement:
                          - Effect: 'Allow'
                            Action:
                                - 'logs:CreateLogGroup'
                                - 'logs:CreateLogStream'
                                - 'logs:PutLogEvents'
                            Resource: !Join ['', ['arn:aws:logs:', !Ref 'AWS::Region', ':', !Ref 'AWS::AccountId', ':log-group:/aws/lambda/sputnik-custom-resource-helper-s3:*']]
                          - Effect: 'Allow'
                            Action:
                                - 's3:GetObject'
                                - 's3:ListBucket'
                                # - 's3:ListObjectsV2'
                            Resource:
                                - !Join ['', ['arn:aws:s3:::', !Ref sourceBucket]]
                                - !Join ['', ['arn:aws:s3:::', !Ref sourceBucket, '/*']]
                          - Effect: 'Allow'
                            Action:
                                - 's3:PutObject'
                            Resource:
                                - !Join ['/', [!Ref destBucketArn, '*']]
                                - !Join ['/', [!Ref dataBucketArn, '*']]

    customResourceS3Helper:
        Type: 'AWS::Lambda::Function'
        Properties:
            FunctionName: 'sputnik-custom-resource-helper-s3'
            Description: 'sputnik Custom resource helper for deploying the app'
            Code:
                S3Bucket: !Ref sourceBucket
                S3Key: !Join ['/', [!Ref lambdaSourceKeyPrefix, 'sputnik-custom-resource-helper-s3.zip']]
            Handler: index.handler
            Runtime: nodejs8.10
            Role: !GetAtt customResourceS3HelperRole.Arn
            Timeout: 300
            MemorySize: 256

Outputs:
    customResourceS3HelperArn:
        Description: 'Custom Resource S3 Helper ARN'
        Value: !GetAtt customResourceS3Helper.Arn
