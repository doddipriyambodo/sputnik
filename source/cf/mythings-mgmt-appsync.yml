AWSTemplateFormatVersion: '2010-09-09'
Description: 'My Things Management - AppSync - Version %%VERSION%%'
Parameters:
    sourceBucket:
        Type: String
        Description: My Things Management S3 bucket.
    sourceKeyPrefix:
        Type: String
        Description: My Things management Source key prefix.
    userPoolId:
        Type: String
        Description: My Things Management User Pool Id.
    settingsTable:
        Type: String
        Description: DynamoDB Table for storing the application settings
    deviceTypesTable:
        Type: String
        Description: DynamoDB Table for storing the device types
    deviceBlueprintsTable:
        Type: String
        Description: DynamoDB Table for storing the device blueprints
    devicesTable:
        Type: String
        Description: DynamoDB Table for storing the devices
    deploymentsTable:
        Type: String
        Description: DynamoDB Table for storing the deployments
    lambdaServiceFactoryResetArn:
        Type: String
        Description: Factory Reset Micro Service ARN
    lambdaServiceSettingsArn:
        Type: String
        Description: Settings Micro Service ARN
    lambdaServiceStatsArn:
        Type: String
        Description: Stats Micro Service ARN
    lambdaServiceDevicesArn:
        Type: String
        Description: Devices Micro Service ARN
    lambdaServiceDeploymentsArn:
        Type: String
        Description: Deployments Micro Service ARN

Resources:

    # ROLE
    appSyncRole:
        Type: 'AWS::IAM::Role'
        Properties:
            AssumeRolePolicyDocument:
                Version: '2012-10-17'
                Statement:
                    - Effect: 'Allow'
                      Principal:
                          Service:
                              - 'appsync.amazonaws.com'
                      Action:
                          - 'sts:AssumeRole'
            Path: '/'
            Policies:
                -
                    PolicyName: 'appSyncDynamoDBPolicy'
                    PolicyDocument:
                        Version: '2012-10-17'
                        Statement:
                            -
                                Effect: 'Allow'
                                Action:
                                    - 'dynamodb:BatchGetItem'
                                    - 'dynamodb:BatchWriteItem'
                                    - 'dynamodb:DeleteItem'
                                    - 'dynamodb:GetItem'
                                    - 'dynamodb:PutItem'
                                    - 'dynamodb:Query'
                                    - 'dynamodb:Scan'
                                    - 'dynamodb:UpdateItem'
                                Resource:
                                    - !Join ['', ['arn:aws:dynamodb:', Ref: 'AWS::Region', ':', Ref: 'AWS::AccountId', ':table/', !Ref settingsTable ]]
                                    - !Join ['', ['arn:aws:dynamodb:', Ref: 'AWS::Region', ':', Ref: 'AWS::AccountId', ':table/', !Ref deviceTypesTable ]]
                                    - !Join ['', ['arn:aws:dynamodb:', Ref: 'AWS::Region', ':', Ref: 'AWS::AccountId', ':table/', !Ref deviceBlueprintsTable ]]
                                    - !Join ['', ['arn:aws:dynamodb:', Ref: 'AWS::Region', ':', Ref: 'AWS::AccountId', ':table/', !Ref devicesTable ]]
                                    - !Join ['', ['arn:aws:dynamodb:', Ref: 'AWS::Region', ':', Ref: 'AWS::AccountId', ':table/', !Ref deploymentsTable ]]
                -
                    PolicyName: 'appSyncLambdaPolicy'
                    PolicyDocument:
                        Version: '2012-10-17'
                        Statement:
                            -
                                Effect: 'Allow'
                                Action:
                                    - 'lambda:InvokeFunction'
                                Resource:
                                    - !Ref lambdaServiceFactoryResetArn
                                    - !Ref lambdaServiceSettingsArn
                                    - !Ref lambdaServiceStatsArn
                                    - !Ref lambdaServiceDevicesArn
                                    - !Ref lambdaServiceDeploymentsArn

    # API
    appSyncGraphQLApi:
        Type: 'AWS::AppSync::GraphQLApi'
        Properties:
            Name: My Things Management AppSync API
            AuthenticationType: AMAZON_COGNITO_USER_POOLS
            UserPoolConfig:
                UserPoolId: !Ref userPoolId
                AwsRegion: !Ref 'AWS::Region'
                DefaultAction: DENY

    # DATA SOURCES - DynamoDB
    appSyncDataSourceSettingsDynamoDB:
        Type: 'AWS::AppSync::DataSource'
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            Name: appSyncDataSourceSettingsDynamoDB
            Description: The Settings DynamoDB table App Sync Data source
            Type: AMAZON_DYNAMODB
            ServiceRoleArn: !Join ['', ['arn:aws:iam::', !Ref 'AWS::AccountId', ':role/', !Ref appSyncRole]]
            DynamoDBConfig:
                AwsRegion: !Ref 'AWS::Region'
                TableName: !Ref settingsTable
    appSyncDataSourceDeviceTypesDynamoDB:
        Type: 'AWS::AppSync::DataSource'
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            Name: appSyncDataSourceDeviceTypesDynamoDB
            Description: The Device Types DynamoDB table App Sync Data Source
            Type: AMAZON_DYNAMODB
            ServiceRoleArn: !Join ['', ['arn:aws:iam::', !Ref 'AWS::AccountId', ':role/', !Ref appSyncRole]]
            DynamoDBConfig:
                AwsRegion: !Ref 'AWS::Region'
                TableName: !Ref deviceTypesTable
    appSyncDataSourceDeviceBlueprintsDynamoDB:
        Type: 'AWS::AppSync::DataSource'
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            Name: appSyncDataSourceDeviceBlueprintsDynamoDB
            Description: The Device Blueprints DynamoDB table App Sync Data Source
            Type: AMAZON_DYNAMODB
            ServiceRoleArn: !Join ['', ['arn:aws:iam::', !Ref 'AWS::AccountId', ':role/', !Ref appSyncRole]]
            DynamoDBConfig:
                AwsRegion: !Ref 'AWS::Region'
                TableName: !Ref deviceBlueprintsTable
    appSyncDataSourceDevicesDynamoDB:
        Type: 'AWS::AppSync::DataSource'
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            Name: appSyncDataSourceDevicesDynamoDB
            Description: The Devices DynamoDB table App Sync Data Source
            Type: AMAZON_DYNAMODB
            ServiceRoleArn: !Join ['', ['arn:aws:iam::', !Ref 'AWS::AccountId', ':role/', !Ref appSyncRole]]
            DynamoDBConfig:
                AwsRegion: !Ref 'AWS::Region'
                TableName: !Ref devicesTable
    appSyncDataSourceDeploymentsDynamoDB:
        Type: 'AWS::AppSync::DataSource'
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            Name: appSyncDataSourceDeploymentsDynamoDB
            Description: The Deployments DynamoDB table App Sync Data Source
            Type: AMAZON_DYNAMODB
            ServiceRoleArn: !Join ['', ['arn:aws:iam::', !Ref 'AWS::AccountId', ':role/', !Ref appSyncRole]]
            DynamoDBConfig:
                AwsRegion: !Ref 'AWS::Region'
                TableName: !Ref deploymentsTable

    # DATA SOURCES - Lambda
    appSyncDataSourceFactoryResetLambda:
        Type: AWS::AppSync::DataSource
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            Name: appSyncDataSourceFactoryResetLambda
            Description: The Factory Reset Lambda App Sync Data Source
            Type: AWS_LAMBDA
            ServiceRoleArn: !Join ['', ['arn:aws:iam::', !Ref 'AWS::AccountId', ':role/', !Ref appSyncRole]]
            LambdaConfig:
                LambdaFunctionArn: !Ref lambdaServiceFactoryResetArn
    appSyncDataSourceSettingsLambda:
        Type: AWS::AppSync::DataSource
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            Name: appSyncDataSourceSettingsLambda
            Description: The Settings Lambda App Sync Data Source
            Type: AWS_LAMBDA
            ServiceRoleArn: !Join ['', ['arn:aws:iam::', !Ref 'AWS::AccountId', ':role/', !Ref appSyncRole]]
            LambdaConfig:
                LambdaFunctionArn: !Ref lambdaServiceSettingsArn
    appSyncDataSourceStatsLambda:
        Type: AWS::AppSync::DataSource
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            Name: appSyncDataSourceStatsLambda
            Description: The Stats Lambda App Sync Data Source
            Type: AWS_LAMBDA
            ServiceRoleArn: !Join ['', ['arn:aws:iam::', !Ref 'AWS::AccountId', ':role/', !Ref appSyncRole]]
            LambdaConfig:
                LambdaFunctionArn: !Ref lambdaServiceStatsArn
    appSyncDataSourceDevicesLambda:
        Type: AWS::AppSync::DataSource
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            Name: appSyncDataSourceDevicesLambda
            Description: The Devices Lambda App Sync Data Source
            Type: AWS_LAMBDA
            ServiceRoleArn: !Join ['', ['arn:aws:iam::', !Ref 'AWS::AccountId', ':role/', !Ref appSyncRole]]
            LambdaConfig:
                LambdaFunctionArn: !Ref lambdaServiceDevicesArn
    appSyncDataSourceDeploymentsLambda:
        Type: AWS::AppSync::DataSource
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            Name: appSyncDataSourceDeploymentsLambda
            Description: The Deployments Lambda App Sync Data Source
            Type: AWS_LAMBDA
            ServiceRoleArn: !Join ['', ['arn:aws:iam::', !Ref 'AWS::AccountId', ':role/', !Ref appSyncRole]]
            LambdaConfig:
                LambdaFunctionArn: !Ref lambdaServiceDeploymentsArn

    # RESOLVERS - QUERIES - DeviceTypes
    appSyncResolverQueryGetDeviceTypes:
        Type: 'AWS::AppSync::Resolver'
        DependsOn: appSyncSchema
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            TypeName: Query
            FieldName: getDeviceTypes
            DataSourceName: !GetAtt appSyncDataSourceDeviceTypesDynamoDB.Name
            RequestMappingTemplateS3Location: !Join ['/', ['s3:/', !Ref sourceBucket, !Ref sourceKeyPrefix, 'request-mapping-template-device-types-get.gql']]
            ResponseMappingTemplateS3Location: !Join ['/', ['s3:/', !Ref sourceBucket, !Ref sourceKeyPrefix, 'response-mapping-template-device-types-get.gql']]
    appSyncResolverQueryGetDeviceType:
        Type: 'AWS::AppSync::Resolver'
        DependsOn: appSyncSchema
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            TypeName: Query
            FieldName: getDeviceType
            DataSourceName: !GetAtt appSyncDataSourceDeviceTypesDynamoDB.Name
            RequestMappingTemplateS3Location: !Join ['/', ['s3:/', !Ref sourceBucket, !Ref sourceKeyPrefix, 'request-mapping-template-device-type-get.gql']]
            ResponseMappingTemplate: '$util.toJson($ctx.result)'

    # RESOLVERS - QUERIES - Settings
    appSyncResolverQueryGetSetting:
        Type: 'AWS::AppSync::Resolver'
        DependsOn: appSyncSchema
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            TypeName: Query
            FieldName: getSetting
            DataSourceName: !GetAtt appSyncDataSourceSettingsDynamoDB.Name
            RequestMappingTemplate: |
                {
                    "version" : "2017-02-28",
                    "operation" : "GetItem",
                    "key" : {
                        "id" : $util.dynamodb.toDynamoDBJson($ctx.args.id)
                    }
                }
            ResponseMappingTemplate: '$util.toJson($ctx.result)'

    # RESOLVERS - QUERIES - Stats
    appSyncResolverQueryGetStat:
        Type: 'AWS::AppSync::Resolver'
        DependsOn: appSyncSchema
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            TypeName: Query
            FieldName: getStat
            DataSourceName: !GetAtt appSyncDataSourceStatsLambda.Name
            RequestMappingTemplate: '{ "version" : "2017-02-28", "operation": "Invoke", "payload": $util.toJson($context.arguments) }'
            ResponseMappingTemplate: '$util.toJson($context.result)'

    # RESOLVERS - QUERIES - Thing Group Auto Registration
    appSyncResolverQueryGetThingAutoRegistrationState:
        Type: 'AWS::AppSync::Resolver'
        DependsOn: appSyncSchema
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            TypeName: Query
            FieldName: getThingAutoRegistrationState
            DataSourceName: !GetAtt appSyncDataSourceSettingsLambda.Name
            RequestMappingTemplate: '{ "version" : "2017-02-28", "operation": "Invoke", "payload": { "cmd": "getThingAutoRegistrationState", "arguments": $util.toJson($context.arguments) } }'
            ResponseMappingTemplate: '$util.toJson($context.result)'

    # RESOLVERS - QUERIES - Device Blueprints
    appSyncResolverQueryGetDeviceBlueprints:
        Type: 'AWS::AppSync::Resolver'
        DependsOn: appSyncSchema
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            TypeName: Query
            FieldName: getDeviceBlueprints
            DataSourceName: !GetAtt appSyncDataSourceDeviceBlueprintsDynamoDB.Name
            RequestMappingTemplate: |
                {
                    "version" : "2017-02-28",
                    "operation" : "Scan",
                    #if( $ctx.args.limit )
                        "limit": $ctx.args.limit,
                    #end
                    #if( ${ctx.args.nextToken} )
                        "nextToken": "${ctx.args.nextToken}"
                    #end
                }
            ResponseMappingTemplate: |
                {
                    "deviceBlueprints": $util.toJson($ctx.result.items),
                    #if( ${ctx.result.nextToken} )
                        "nextToken": "${ctx.result.nextToken}",
                    #end
                }
    appSyncResolverQueryGetDeviceBlueprint:
        Type: 'AWS::AppSync::Resolver'
        DependsOn: appSyncSchema
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            TypeName: Query
            FieldName: getDeviceBlueprint
            DataSourceName: !GetAtt appSyncDataSourceDeviceBlueprintsDynamoDB.Name
            RequestMappingTemplate: |
                {
                    "version" : "2017-02-28",
                    "operation" : "GetItem",
                    "key" : {
                        "id" : $util.dynamodb.toDynamoDBJson($ctx.args.id)
                    }
                }
            ResponseMappingTemplate: '$util.toJson($ctx.result)'

    # RESOLVERS - QUERIES - Devices
    appSyncResolverQueryGetDevices:
        Type: 'AWS::AppSync::Resolver'
        DependsOn: appSyncSchema
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            TypeName: Query
            FieldName: getDevices
            DataSourceName: !GetAtt appSyncDataSourceDevicesDynamoDB.Name
            RequestMappingTemplateS3Location: !Join ['/', ['s3:/', !Ref sourceBucket, !Ref sourceKeyPrefix, 'request-mapping-template-devices-get.gql']]
            ResponseMappingTemplateS3Location: !Join ['/', ['s3:/', !Ref sourceBucket, !Ref sourceKeyPrefix, 'response-mapping-template-devices-get.gql']]
    appSyncResolverQueryGetDevicesOfDeviceType:
        Type: 'AWS::AppSync::Resolver'
        DependsOn: appSyncSchema
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            TypeName: Query
            FieldName: getDevicesOfDeviceType
            DataSourceName: !GetAtt appSyncDataSourceDevicesDynamoDB.Name
            RequestMappingTemplateS3Location: !Join ['/', ['s3:/', !Ref sourceBucket, !Ref sourceKeyPrefix, 'request-mapping-template-devices-of-device-type-get.gql']]
            ResponseMappingTemplateS3Location: !Join ['/', ['s3:/', !Ref sourceBucket, !Ref sourceKeyPrefix, 'response-mapping-template-devices-of-device-type-get.gql']]
    appSyncResolverQueryGetDevicesWithDeviceBlueprint:
        Type: 'AWS::AppSync::Resolver'
        DependsOn: appSyncSchema
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            TypeName: Query
            FieldName: getDevicesWithDeviceBlueprint
            DataSourceName: !GetAtt appSyncDataSourceDevicesDynamoDB.Name
            RequestMappingTemplateS3Location: !Join ['/', ['s3:/', !Ref sourceBucket, !Ref sourceKeyPrefix, 'request-mapping-template-devices-with-device-blueprint-get.gql']]
            ResponseMappingTemplateS3Location: !Join ['/', ['s3:/', !Ref sourceBucket, !Ref sourceKeyPrefix, 'response-mapping-template-devices-with-device-blueprint-get.gql']]
    appSyncResolverQueryGetDevice:
        Type: 'AWS::AppSync::Resolver'
        DependsOn: appSyncSchema
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            TypeName: Query
            FieldName: getDevice
            DataSourceName: !GetAtt appSyncDataSourceDevicesDynamoDB.Name
            RequestMappingTemplateS3Location: !Join ['/', ['s3:/', !Ref sourceBucket, !Ref sourceKeyPrefix, 'request-mapping-template-device-get.gql']]
            ResponseMappingTemplate: '$util.toJson($ctx.result)'
    appSyncResolverQueryGetDeviceStats:
        Type: 'AWS::AppSync::Resolver'
        DependsOn: appSyncSchema
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            TypeName: Query
            FieldName: getDeviceStats
            DataSourceName: !GetAtt appSyncDataSourceDevicesLambda.Name
            RequestMappingTemplateS3Location: !Join ['/', ['s3:/', !Ref sourceBucket, !Ref sourceKeyPrefix, 'request-mapping-template-device-stats-get.gql']]
            ResponseMappingTemplate: '$util.toJson($context.result)'

    # RESOLVERS - QUERIES - Deployments
    appSyncResolverQueryGetDeployments:
        Type: 'AWS::AppSync::Resolver'
        DependsOn: appSyncSchema
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            TypeName: Query
            FieldName: getDeployments
            DataSourceName: !GetAtt appSyncDataSourceDeploymentsDynamoDB.Name
            RequestMappingTemplateS3Location: !Join ['/', ['s3:/', !Ref sourceBucket, !Ref sourceKeyPrefix, 'request-mapping-template-deployments-get.gql']]
            ResponseMappingTemplateS3Location: !Join ['/', ['s3:/', !Ref sourceBucket, !Ref sourceKeyPrefix, 'response-mapping-template-deployments-get.gql']]

    # RESOLVERS - MUTATIONS - Devices
    appSyncResolverMutationAddDevice:
        Type: 'AWS::AppSync::Resolver'
        DependsOn: appSyncSchema
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            TypeName: Mutation
            FieldName: addDevice
            DataSourceName: !GetAtt appSyncDataSourceDevicesLambda.Name
            RequestMappingTemplateS3Location: !Join ['/', ['s3:/', !Ref sourceBucket, !Ref sourceKeyPrefix, 'request-mapping-template-device-add.gql']]
            ResponseMappingTemplate: '$util.toJson($context.result)'
    appSyncResolverMutationDeleteDevice:
        Type: 'AWS::AppSync::Resolver'
        DependsOn: appSyncSchema
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            TypeName: Mutation
            FieldName: deleteDevice
            DataSourceName: !GetAtt appSyncDataSourceDevicesLambda.Name
            RequestMappingTemplateS3Location: !Join ['/', ['s3:/', !Ref sourceBucket, !Ref sourceKeyPrefix, 'request-mapping-template-device-delete.gql']]
            ResponseMappingTemplate: '$util.toJson($ctx.result)'
    appSyncResolverMutationUpdateDevice:
        Type: 'AWS::AppSync::Resolver'
        DependsOn: appSyncSchema
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            TypeName: Mutation
            FieldName: updateDevice
            DataSourceName: !GetAtt appSyncDataSourceDevicesDynamoDB.Name
            RequestMappingTemplateS3Location: !Join ['/', ['s3:/', !Ref sourceBucket, !Ref sourceKeyPrefix, 'request-mapping-template-device-update.gql']]
            ResponseMappingTemplate: '$util.toJson($context.result)'

    # RESOLVERS - MUTATIONS - DeviceTypes
    appSyncResolverMutationAddDeviceType:
        Type: 'AWS::AppSync::Resolver'
        DependsOn: appSyncSchema
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            TypeName: Mutation
            FieldName: addDeviceType
            DataSourceName: !GetAtt appSyncDataSourceDeviceTypesDynamoDB.Name
            RequestMappingTemplateS3Location: !Join ['/', ['s3:/', !Ref sourceBucket, !Ref sourceKeyPrefix, 'request-mapping-template-device-type-add.gql']]
            ResponseMappingTemplate: '$util.toJson($ctx.result)'
    appSyncResolverMutationDeleteDeviceType:
        Type: 'AWS::AppSync::Resolver'
        DependsOn: appSyncSchema
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            TypeName: Mutation
            FieldName: deleteDeviceType
            DataSourceName: !GetAtt appSyncDataSourceDeviceTypesDynamoDB.Name
            RequestMappingTemplateS3Location: !Join ['/', ['s3:/', !Ref sourceBucket, !Ref sourceKeyPrefix, 'request-mapping-template-device-type-delete.gql']]
            ResponseMappingTemplate: '$util.toJson($ctx.result)'
    appSyncResolverMutationUpdateDeviceType:
        Type: 'AWS::AppSync::Resolver'
        DependsOn: appSyncSchema
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            TypeName: Mutation
            FieldName: updateDeviceType
            DataSourceName: !GetAtt appSyncDataSourceDeviceTypesDynamoDB.Name
            RequestMappingTemplateS3Location: !Join ['/', ['s3:/', !Ref sourceBucket, !Ref sourceKeyPrefix, 'request-mapping-template-device-type-update.gql']]
            ResponseMappingTemplate: '$util.toJson($ctx.result)'

    # RESOLVERS - MUTATIONS - Device Blueprints
    appSyncResolverMutationAddDeviceBlueprint:
        Type: 'AWS::AppSync::Resolver'
        DependsOn: appSyncSchema
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            TypeName: Mutation
            FieldName: addDeviceBlueprint
            DataSourceName: !GetAtt appSyncDataSourceDeviceBlueprintsDynamoDB.Name
            RequestMappingTemplateS3Location: !Join ['/', ['s3:/', !Ref sourceBucket, !Ref sourceKeyPrefix, 'request-mapping-template-device-blueprint-add.gql']]
            ResponseMappingTemplate: '$util.toJson($ctx.result)'
    appSyncResolverMutationDeleteDeviceBlueprint:
        Type: 'AWS::AppSync::Resolver'
        DependsOn: appSyncSchema
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            TypeName: Mutation
            FieldName: deleteDeviceBlueprint
            DataSourceName: !GetAtt appSyncDataSourceDeviceBlueprintsDynamoDB.Name
            RequestMappingTemplateS3Location: !Join ['/', ['s3:/', !Ref sourceBucket, !Ref sourceKeyPrefix, 'request-mapping-template-device-blueprint-delete.gql']]
            ResponseMappingTemplate: '$util.toJson($ctx.result)'
    appSyncResolverMutationUpdateDeviceBlueprint:
        Type: 'AWS::AppSync::Resolver'
        DependsOn: appSyncSchema
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            TypeName: Mutation
            FieldName: updateDeviceBlueprint
            DataSourceName: !GetAtt appSyncDataSourceDeviceBlueprintsDynamoDB.Name
            RequestMappingTemplateS3Location: !Join ['/', ['s3:/', !Ref sourceBucket, !Ref sourceKeyPrefix, 'request-mapping-template-device-blueprint-update.gql']]
            ResponseMappingTemplate: '$util.toJson($ctx.result)'

    # RESOLVERS - MUTATIONS - FactoryReset
    appSyncResolverMutationFactoryResetDeviceTypes:
        Type: 'AWS::AppSync::Resolver'
        DependsOn: appSyncSchema
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            TypeName: Mutation
            FieldName: factoryReset
            DataSourceName: !GetAtt appSyncDataSourceFactoryResetLambda.Name
            RequestMappingTemplate: '{ "version" : "2017-02-28", "operation": "Invoke", "payload": $util.toJson($context.arguments) }'
            ResponseMappingTemplate: '$util.toJson($context.result)'

    # RESOLVERS - MUTATIONS - ThingAutoRegistration
    appSyncResolverMutationSetThingAutoRegistrationState:
        Type: 'AWS::AppSync::Resolver'
        DependsOn: appSyncSchema
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            TypeName: Mutation
            FieldName: setThingAutoRegistrationState
            DataSourceName: !GetAtt appSyncDataSourceSettingsLambda.Name
            RequestMappingTemplate: '{ "version" : "2017-02-28", "operation": "Invoke", "payload": { "cmd": "setThingAutoRegistrationState", "enabled": $context.arguments.enabled } }'
            ResponseMappingTemplate: '$util.toJson($context.result)'

    # RESOLVERS - MUTATIONS - Deployments
    appSyncResolverMutationAddDeployment:
        Type: 'AWS::AppSync::Resolver'
        DependsOn: appSyncSchema
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            TypeName: Mutation
            FieldName: addDeployment
            DataSourceName: !GetAtt appSyncDataSourceDeploymentsLambda.Name
            RequestMappingTemplateS3Location: !Join ['/', ['s3:/', !Ref sourceBucket, !Ref sourceKeyPrefix, 'request-mapping-template-deployment-add.gql']]
            ResponseMappingTemplate: '$util.toJson($context.result)'

    # SCHEMA
    appSyncSchema:
        Type: 'AWS::AppSync::GraphQLSchema'
        Properties:
            ApiId: !GetAtt appSyncGraphQLApi.ApiId
            DefinitionS3Location: !Join ['/', ['s3:/', !Ref sourceBucket, !Ref sourceKeyPrefix, 'api-schema.gql']]

Outputs:
    appSyncGraphQLApi:
        Description: 'My Things Management AppSync API'
        Value: !Ref appSyncGraphQLApi
    appSyncGraphQLUrl:
        Description: 'My Things Management AppSync Endpoint URL'
        Value: !GetAtt appSyncGraphQLApi.GraphQLUrl
