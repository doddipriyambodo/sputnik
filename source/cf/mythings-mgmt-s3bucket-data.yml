AWSTemplateFormatVersion: '2010-09-09'
Description: 'My Things Management - Data Bucket - Version %%VERSION%%'

Resources:
    dataBucketAccessPolicy:
        Type: "AWS::IAM::ManagedPolicy"
        DeletionPolicy: Retain
        Properties:
            Description: "My Things Management policy to access the Data Bucket."
            PolicyDocument:
                Version: "2012-10-17"
                Statement:
                    -
                        Effect: "Allow"
                        Action:
                            # TODO BE MORE RESTRICTIVE
                            - "s3:ListBucket"
                            - "s3:GetObject"
                            - "s3:ListObjects"
                        Resource:
                            - !Join ["*", [!GetAtt dataBucket.Arn, "/*"]]
                            - !Join ["", [!GetAtt dataBucket.Arn, "*"]]

    dataBucket:
        Type: AWS::S3::Bucket
        DeletionPolicy: Retain
        Properties:
            CorsConfiguration:
                CorsRules:
                    -
                        AllowedOrigins:
                            - "*"
                        AllowedMethods:
                            - "HEAD"
                            - "GET"
                        AllowedHeaders:
                            - "*"
Outputs:
    dataBucket:
        Description: 'My Things Management Data Bucket'
        Value: !Ref dataBucket
    dataBucketArn:
        Description: 'My Things Management Data Bucket ARN'
        Value: !GetAtt dataBucket.Arn
    dataBucketAccessPolicyArn:
        Description: 'My Things Management Data Bucket Access Policy ARN'
        Value: !Ref dataBucketAccessPolicy
