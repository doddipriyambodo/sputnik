{
    "id": "aws-mini-connected-factory-v1.1",
    "name": "AWS Mini Connected Factory v1.1",
    "description": "AWS Mini Connected Factory v1.1",
    "prefix": "AMCF1_",
    "spec": {
        "devices": [{
                "defaultDeviceTypeId": "aws-esp32-3d-belt-v1.0",
                "deviceBlueprintId": "aws-afr-3d-belt-mini-connected-factory-v1.0",
                "ref": "device_0"
            },
            {
                "defaultDeviceTypeId": "aws-deeplens-v1.0",
                "deviceBlueprintId": "aws-gg-mini-connected-factory-v1.0",
                "ref": "device_1",
                "spec": {
                    "afterActions": [
                    ],
                    "DeviceDefinitionVersion": {
                        "Devices": [{
                            "CertificateArn": "!GetAtt[device_0.cert.certificateArn]",
                            "SyncShadow": true,
                            "ThingArn": "!GetAtt[device_0.thingArn]"
                        }]
                    },
                    "FunctionDefinitionVersion": {
                        "Functions": [{
                                "FunctionArn": "arn:aws:lambda:[AWS_REGION]:[AWS_ACCOUNT]:function:aws-mini-connected-factory-belt-serial-python:MTM",
                                "FunctionConfiguration": {
                                    "EncodingType": "json",
                                    "Environment": {
                                        "ResourceAccessPolicies": [{
                                            "Permission": "rw",
                                            "ResourceId": "serial-port"
                                        }],
                                        "Variables": {
                                            "SERIALPORT_PORT": "/dev/ttyUSB0",
                                            "SERIALPORT_SPEED": "115200",
                                            "THING_NAME": "!GetAtt[device_0.thingName]"
                                        }
                                    },
                                    "MemorySize": 262144,
                                    "Pinned": true,
                                    "Timeout": 3
                                }
                            }, {
                                "FunctionArn": "arn:aws:lambda:[AWS_REGION]:[AWS_ACCOUNT]:function:aws-mini-connected-factory-camera-python:MTM",
                                "FunctionConfiguration": {
                                    "EncodingType": "json",
                                    "Environment": {
                                        "AccessSysfs": false,
                                        "ResourceAccessPolicies": [{
                                                "Permission": "rw",
                                                "ResourceId": "tmp"
                                            },
                                            {
                                                "Permission": "rw",
                                                "ResourceId": "mtm-model-lego-helmets"
                                            },
                                            {
                                                "Permission": "ro",
                                                "ResourceId": "[AWS_CAM_STREAM]"
                                            },
                                            {
                                                "Permission": "rw",
                                                "ResourceId": "gpu"
                                            }
                                        ],
                                        "Variables": {
                                            "ML_MODEL_PATH": "/ml/helmets/image-classification"
                                        }
                                    },
                                    "MemorySize": 1048576,
                                    "Pinned": true,
                                    "Timeout": 25
                                }
                            }
                        ]
                    },
                    "ResourceDefinitionVersion": {
                        "Resources": [{
                            "Id": "serial-port",
                            "Name": "serial-port",
                            "ResourceDataContainer": {
                                "LocalDeviceResourceData": {
                                    "GroupOwnerSetting": {
                                        "AutoAddGroupOwner": false,
                                        "GroupOwner": "dialout"
                                    },
                                    "SourcePath": "/dev/ttyUSB0"
                                }
                            }
                        }]
                    },
                    "SubscriptionDefinitionVersion": {
                        "Subscriptions": [{
                            "Source": "arn:aws:lambda:[AWS_REGION]:[AWS_ACCOUNT]:function:aws-mini-connected-factory-belt-serial-python:MTM",
                            "Subject": "mtm/!GetAtt[device_0.thingName]/sensors",
                            "Target": "cloud"
                        }]
                    }

                }
            }
        ],
        "actions": {
            "description": "this is work in progress, but the idea would be to build actions like this rather than like above",
            "resources": {
                "device_0": {
                    "defaultDeviceTypeId": "aws-esp32-3d-belt-v1.0",
                    "deviceBlueprintId": "aws-afr-3d-belt-mini-connected-factory-v1.0"
                },
                "device_1": {
                    "defaultDeviceTypeId": "aws-deeplens-v1.0",
                    "deviceBlueprintId": "aws-gg-mini-connected-factory-v1.0",
                    "spec": {
                        "actions": {
                            "post": [
                                "function afterAction(spec) { if ( (index = spec.FunctionDefinitionVersion.Functions.findIndex(f => f.FunctionArn === \"arn:aws:lambda:[AWS_REGION]:[AWS_ACCOUNT]:function:aws-mini-connected-factory-belt-serial-python:MTM\")) !== -1 ) { spec.FunctionDefinitionVersion.Functions[index].FunctionConfiguration.Environment.Variables.BELT_IOT_THING_NAME = '!GetAtt[device_0.thingName]' } return spec; }",
                                "function afterAction(spec) { if ( (index = spec.FunctionDefinitionVersion.Functions.findIndex(f => f.FunctionArn === \"arn:aws:lambda:[AWS_REGION]:[AWS_ACCOUNT]:function:aws-mini-connected-factory-camera-python:MTM\")) !== -1 ) { spec.FunctionDefinitionVersion.Functions[index].FunctionConfiguration.Environment.Variables.BELT_IOT_THING_NAME = '!GetAtt[device_0.thingName]' } return spec; }"
                            ]
                        },
                        "DeviceDefinitionVersion": {
                            "Devices": [{
                                "CertificateArn": "!GetAtt[device_0.cert.certificateArn]",
                                "SyncShadow": true,
                                "ThingArn": "!GetAtt[device_0.thingArn]"
                            }]
                        }
                    }
                }
            }
        }
    }
}
