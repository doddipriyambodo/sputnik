{
    "id": "gg-ml-lego-hats-v1.0",
    "name": "GG ML Lego Hats detection v1.0",
    "type": "GREENGRASS",
    "compatibility": ["deeplens-v1.0", "deeplens-no-lambda-v1.0", "intel-up2-webcam-v0.1"],
    "deviceTypeMappings": [{
        "substitute": "CAM_STREAM_ID",
        "value": {
            "deeplens-no-lambda-v1.0": "stream",
            "deeplens-v1.0": "stream",
            "intel-up2-webcam-v0.1": "video0"
        }
    }, {
        "substitute": "CAM_STREAM_PERMISSIONS",
        "value": {
            "deeplens-no-lambda-v1.0": "ro",
            "deeplens-v1.0": "ro",
            "intel-up2-webcam-v0.1": "rw"
        }
    }, {
        "substitute": "CAMERA_TYPE",
        "value": {
            "deeplens-no-lambda-v1.0": "awscam",
            "deeplens-v1.0": "awscam",
            "intel-up2-webcam-v0.1": "video0"
        }
    }, {
        "substitute": "PATH_TO_CAMERA",
        "value": {
            "deeplens-no-lambda-v1.0": "/opt/awscam/out/ch2_out.mjpeg",
            "deeplens-v1.0": "/opt/awscam/out/ch2_out.mjpeg",
            "intel-up2-webcam-v0.1": "/dev/video0"
        }
    }, {
        "substitute": "ML_MODEL_TYPE",
        "value": {
            "deeplens-no-lambda-v1.0": "optimized",
            "deeplens-v1.0": "optimized",
            "intel-up2-webcam-v0.1": "non_optimized"
        }
    }, {
        "substitute": "GPU",
        "value": {
            "deeplens-no-lambda-v1.0": "gpu",
            "deeplens-v1.0": "gpu",
            "intel-up2-webcam-v0.1": "gpu"
        }
    }],
    "spec": {
        "Shadow": {
            "desired": {
                "inferenceCamera": {
                    "capture": "Off",
                    "threaded": "Off",
                    "s3Upload": "Off",
                    "s3Bucket": "[DATA_BUCKET]",
                    "resolution": "858x480",
                    "crop": "224x224",
                    "s3KeyPrefix": "gg-ml-lego-hats-v1.0/[CORE]/default",
                    "categories": ["hat", "nohat", "nolego"]
                }
            }
        },
        "FunctionDefinitionVersion": {
            "Functions": [{
                    "FunctionArn": "arn:aws:lambda:[AWS_REGION]:[AWS_ACCOUNT]:function:ml-inference-camera-python:MTM",
                    "FunctionConfiguration": {
                        "EncodingType": "json",
                        "Environment": {
                            "AccessSysfs": true,
                            "ResourceAccessPolicies": [{
                                    "Permission": "rw",
                                    "ResourceId": "tmp"
                                },
                                {
                                    "Permission": "rw",
                                    "ResourceId": "mtm-model-lego-helmets"
                                },
                                {
                                    "Permission": "[CAM_STREAM_PERMISSIONS]",
                                    "ResourceId": "[CAM_STREAM_ID]"
                                },
                                {
                                    "Permission": "rw",
                                    "ResourceId": "[GPU]"
                                }
                            ],
                            "Variables": {
                                "ML_MODEL_TYPE": "[ML_MODEL_TYPE]",
                                "ML_MODEL_PATH": "/ml/helmets/",
                                "ML_MODEL_NAME": "image-classification",
                                "CAMERA_TYPE": "[CAMERA_TYPE]",
                                "PATH_TO_CAMERA": "[PATH_TO_CAMERA]"
                            }
                        },
                        "MemorySize": 2097152,
                        "Pinned": true,
                        "Timeout": 25
                    }
                }
            ]
        },
        "ResourceDefinitionVersion": {
            "Resources": [{
                "Id": "mtm-model-lego-helmets",
                "Name": "mtm-model-lego-helmets",
                "ResourceDataContainer": {
                    "S3MachineLearningModelResourceData": {
                        "DestinationPath": "/ml/helmets/",
                        "S3Uri": "[DATA_BUCKET_S3_URL]/reinvent-2018-mcf/models/legomodel-v1.1.8-224-3cat.tar.gz"
                    }
                }
            },
            {
                "Id": "tmp",
                "Name": "tmp_resource",
                "ResourceDataContainer": {
                    "LocalVolumeResourceData": {
                        "DestinationPath": "/tmp",
                        "GroupOwnerSetting": {
                            "AutoAddGroupOwner": true
                        },
                        "SourcePath": "/tmp"
                    }
                }
            }]
        },
        "SubscriptionDefinitionVersion": {
            "Subscriptions": [{
                    "Source": "GGShadowService",
                    "Subject": "$aws/things/[CORE]/shadow/update/accepted",
                    "Target": "arn:aws:lambda:[AWS_REGION]:[AWS_ACCOUNT]:function:ml-inference-camera-python:MTM"
                }, {
                    "Source": "arn:aws:lambda:[AWS_REGION]:[AWS_ACCOUNT]:function:ml-inference-camera-python:MTM",
                    "Subject": "mtm/[CORE]/logger",
                    "Target": "cloud"
                }, {
                    "Source": "arn:aws:lambda:[AWS_REGION]:[AWS_ACCOUNT]:function:ml-inference-camera-python:MTM",
                    "Subject": "mtm/[CORE]/inference",
                    "Target": "cloud"
                }
            ]
        }
    }
}
