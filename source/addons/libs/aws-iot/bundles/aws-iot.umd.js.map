{"version":3,"file":"aws-iot.umd.js.map","sources":["ng://aws-iot/lib/aws-iot.service.ts","ng://aws-iot/lib/aws-iot.component.ts","ng://aws-iot/lib/aws-iot.module.ts"],"sourcesContent":["// Angular\nimport { Injectable } from '@angular/core';\nimport { Subject } from 'rxjs';\n\n// AWS\nimport { AmplifyService } from 'aws-amplify-angular';\nimport Amplify from 'aws-amplify';\nimport { AWSIoTProvider } from '@aws-amplify/pubsub/lib/Providers';\n\n// -----\nimport gql from 'graphql-tag';\n\nconst attachPrincipalPolicy = gql`\n    mutation AttachPrincipalPolicy($policyName: String!, $principal: String!) {\n        attachPrincipalPolicy(policyName: $policyName, principal: $principal)\n    }\n`;\nconst getThingShadow = gql`\n    query GetThingShadow($params: AWSJSON!) {\n        getThingShadow(params: $params) {\n            payload\n        }\n    }\n`;\nconst updateThingShadow = gql`\n    mutation UpdateThingShadow($params: AWSJSON!) {\n        updateThingShadow(params: $params) {\n            payload\n        }\n    }\n`;\n\ndeclare var appVariables: any;\n\n\n@Injectable(\n// {\n//     providedIn: 'root'\n// }\n)\nexport class AWSIoTService {\n\n    private connectionSubject: any = new Subject<boolean>();\n    public connectionObservable$ = this.connectionSubject.asObservable();\n    public isConnected = false;\n\n    constructor(private amplifyService: AmplifyService) { }\n\n    connect() {\n        this.amplifyService\n            .auth()\n            .currentCredentials()\n            .then(credentials => {\n\n                const promise: any = this.amplifyService.api().graphql({\n                    query: attachPrincipalPolicy.loc.source.body,\n                    variables: {\n                        policyName: appVariables.IOT_COGNITO_POLICY,\n                        principal: credentials.identityId\n                    }\n                });\n\n                return promise.then(result => {\n                    result = result.data.attachPrincipalPolicy;\n                    if (result === true) {\n                        Amplify.addPluggable(\n                            new AWSIoTProvider({\n                                aws_pubsub_region: appVariables.REGION,\n                                aws_pubsub_endpoint: 'wss://' + appVariables.IOT_ENDPOINT + '/mqtt'\n                            })\n                        );\n                    }\n                    return result;\n                });\n            })\n            .then(result => {\n                console.log('Connected to AWS IoT', result);\n                this.isConnected = true;\n                this.connectionSubject.next(this.isConnected);\n            })\n            .catch(err => {\n                console.error('Error while trying to connect to AWS IoT:', err);\n                this.isConnected = false;\n                this.connectionSubject.next(this.isConnected);\n            });\n    }\n\n    subscribe(topic: string, onMessage, onError) {\n        return this.amplifyService\n            .pubsub()\n            .subscribe(topic)\n            .subscribe(\n                data => onMessage(data),\n                error => onError(error),\n                () => {\n                    console.log('Subscription to', topic, 'done.');\n                }\n            );\n    }\n\n    getThingShadow(params: any) {\n        const promise: any = this.amplifyService.api().graphql({\n            query: getThingShadow.loc.source.body,\n            variables: {\n                params: JSON.stringify(params)\n            }\n        });\n        return promise.then(result => JSON.parse(result.data.getThingShadow.payload));\n    }\n\n    updateThingShadow(params: any) {\n        const promise: any = this.amplifyService.api().graphql({\n            query: updateThingShadow.loc.source.body,\n            variables: {\n                params: JSON.stringify(params)\n            }\n        });\n\n        return promise.then(result => JSON.parse(result.data.updateThingShadow.payload));\n    }\n}\n","import { Component, OnDestroy } from '@angular/core';\nimport { Subscription } from 'rxjs';\n\n// Services\nimport { AWSIoTService } from './aws-iot.service';\n\nimport { _ } from 'underscore';\n\nexport class IoTSubscription {\n    topic: string;\n    onMessage: (data: any) => void;\n    onError: (data: any) => void;\n}\n\n@Component({\n    selector: 'aws-iot-component',\n    template: ''\n})\nexport class AWSIoTComponent implements OnDestroy {\n    private subscriptions: Subscription = new Subscription();\n    private iotSubscriptions: IoTSubscription[];\n\n    public desired: any = {};\n    public reported: any = {};\n\n    constructor(private _iotService: AWSIoTService) {}\n\n    ngOnDestroy() {\n        console.log('Unsubscribing to topics');\n        this.subscriptions.unsubscribe();\n    }\n\n    protected subscribe(iotSubscriptions: IoTSubscription[]) {\n        this.iotSubscriptions = iotSubscriptions;\n        this._iotService.connectionObservable$.subscribe((connected: boolean) => {\n            console.log('Change of connection state: setting subscriptions', connected);\n            this.setSubscriptions();\n        });\n        this.setSubscriptions();\n    }\n\n    private setSubscriptions() {\n        if (this._iotService.isConnected) {\n            this.iotSubscriptions.forEach((sub: IoTSubscription) => {\n                console.log('Subscribing to topic:', sub.topic);\n                this.subscriptions.add(this._iotService.subscribe(sub.topic, sub.onMessage, sub.onError));\n            });\n        } else {\n            console.log('Not connected to AWS IoT: Cant subscribe');\n        }\n    }\n    protected updateIncomingShadow(incoming, shadowField = null) {\n        if (incoming.hasOwnProperty('state') && incoming.state.hasOwnProperty('reported')) {\n            if (shadowField !== null && incoming.state.reported.hasOwnProperty(shadowField)) {\n                _.extend(this.reported, incoming.state.reported[shadowField]);\n                // this.reported = incoming.state.reported[shadowField];\n            } else {\n                _.extend(this.reported, incoming.state.reported);\n                // this.reported = incoming.state.reported;\n            }\n        }\n        if (incoming.hasOwnProperty('state') && incoming.state.hasOwnProperty('desired')) {\n            if (shadowField !== null && incoming.state.desired.hasOwnProperty(shadowField)) {\n                _.extend(this.desired, incoming.state.desired[shadowField]);\n                // this.desired = incoming.state.desired[shadowField];\n            } else {\n                _.extend(this.desired, incoming.state.desired);\n                // this.desired = incoming.state.desired;\n            }\n        }\n    }\n\n    protected getLastState(thingName, shadowField = null) {\n        return this._iotService\n            .getThingShadow({\n                thingName: thingName\n            })\n            .then(result => {\n                this.updateIncomingShadow(result, shadowField);\n                return result;\n            })\n            .catch(err => {\n                console.error(err);\n                throw err;\n            });\n    }\n\n    protected updateDesiredShadow(thingName, desiredState) {\n        return this._iotService.updateThingShadow({\n            thingName: thingName,\n            payload: JSON.stringify({\n                state: {\n                    desired: desiredState\n                }\n            })\n        });\n    }\n}\n","// Angular\nimport { NgModule } from '@angular/core';\nimport { CommonModule } from '@angular/common';\n\n// AWS Specific\nimport { AmplifyAngularModule } from 'aws-amplify-angular';\n\n// --------\nimport { AWSIoTComponent } from './aws-iot.component';\nimport { AWSIoTService } from './aws-iot.service';\n\n@NgModule({\n    declarations: [AWSIoTComponent],\n    exports: [AWSIoTComponent],\n    imports: [AmplifyAngularModule, CommonModule],\n    providers: [AWSIoTService]\n})\nexport class AWSIoTModule {}\n"],"names":["Subject","AWSIoTProvider","Injectable","AmplifyService","Subscription","_","Component","NgModule","AmplifyAngularModule","CommonModule"],"mappings":"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"}
